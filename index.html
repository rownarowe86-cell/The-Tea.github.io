<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Tea ‚òï</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs (Modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* ---------------- Global State & Config ---------------- */
    const firebaseConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'the-tea-app';
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    /* ---------------- DOM Elements ---------------- */
    const teaForm = document.getElementById("teaForm");
    const feed = document.getElementById("feed");
    const messageDisplay = document.getElementById("messageDisplay");

    /* ---------------- Authentication (Rule 3) ---------------- */
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth failed:", error);
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        startListening(); // Start fetching data only after auth
      }
    });

    initAuth();

    /* ---------------- Feed Listener (Rule 1 & 2) ---------------- */
    function startListening() {
      // Public collection path as per Rule 1
      const teaCollection = collection(db, 'artifacts', appId, 'public', 'data', 'pours');
      
      // Simple query as per Rule 2 (no complex ordering in query to avoid index errors)
      onSnapshot(teaCollection, (snapshot) => {
        const posts = [];
        snapshot.forEach((doc) => {
          posts.push({ id: doc.id, ...doc.data() });
        });

        // Sort in memory (Rule 2)
        posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

        renderFeed(posts);
      }, (error) => {
        console.error("Firestore error:", error);
      });
    }

    function renderFeed(posts) {
      feed.innerHTML = "";
      if (posts.length === 0) {
        feed.innerHTML = `<p class="text-stone-400 italic text-center py-10">No tea spilled yet. Be the first.</p>`;
        return;
      }

      posts.forEach(post => {
        const div = document.createElement("div");
        div.className = "bg-stone-50 p-4 rounded-lg border border-stone-200 shadow-sm mb-4 animate-in fade-in duration-500";
        div.innerHTML = `
          <div class="text-xs text-stone-400 mb-1">
            ${post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleString() : 'Just now'}
          </div>
          <p class="text-stone-800 break-words leading-relaxed">${post.content}</p>
        `;
        feed.appendChild(div);
      });
    }

    /* ---------------- Submit Logic ---------------- */
    teaForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (!currentUser) {
        showMessage("Authenticating... please try again in a second.", "text-amber-600");
        return;
      }

      const content = document.getElementById("content").value.trim();
      if (!content) return;

      try {
        const teaCollection = collection(db, 'artifacts', appId, 'public', 'data', 'pours');
        await addDoc(teaCollection, {
          content: content,
          userId: currentUser.uid,
          timestamp: serverTimestamp()
        });

        teaForm.reset();
        showMessage("Tea spilled successfully! ‚òï", "text-green-600");
      } catch (error) {
        console.error("Submission error:", error);
        showMessage("Failed to spill. Try again.", "text-red-600");
      }
    });

    function showMessage(msg, colorClass) {
      messageDisplay.textContent = msg;
      messageDisplay.className = `text-sm mt-2 transition-opacity duration-300 ${colorClass}`;
      setTimeout(() => {
        messageDisplay.style.opacity = '0';
        setTimeout(() => { 
          messageDisplay.textContent = ""; 
          messageDisplay.style.opacity = '1';
        }, 300);
      }, 3000);
    }
  </script>

  <style>
    body {
      background-color: #fdfbf7;
      font-family: 'Georgia', serif;
    }
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #d6d3d1;
      border-radius: 10px;
    }
  </style>
</head>
<body class="text-stone-800 flex flex-col h-screen overflow-hidden">

  <!-- Fixed Header -->
  <header class="bg-stone-900 text-white p-4 shadow-lg z-50 flex items-center justify-center gap-3">
    <span class="text-2xl">üçÉ</span>
    <h1 class="text-2xl font-bold tracking-widest uppercase">The Tea</h1>
  </header>

  <!-- Main Grid Layout -->
  <div class="flex flex-1 overflow-hidden">
    
    <!-- Left Section: About (Sidebar) -->
    <aside class="hidden lg:flex w-1/4 bg-stone-100 p-8 flex-col justify-start border-r border-stone-200 overflow-y-auto">
      <h2 class="text-xl font-bold mb-6 border-b border-stone-300 pb-2 uppercase tracking-tighter">About The Tea</h2>
      <p class="text-stone-700 leading-relaxed italic">
        "The kettle is screaming, and so are the headlines you haven‚Äôt seen yet. Welcome to The Tea, the only corner of the internet where the whispers are louder than the shouts. We aren't just spilling the truth; we‚Äôre brewing the scandals that others try to bury in the dark. So, pull up a chair, check your conscience at the door, and lower your voice‚Äîbecause what we‚Äôre about to pour is piping hot, strictly off the record, and absolutely delicious."
      </p>
      <div class="mt-auto pt-8 text-stone-400 text-xs">
        &copy; 2024 The Tea. All rights reserved.
      </div>
    </aside>

    <!-- Center Section: Spill Area -->
    <main class="flex-1 flex flex-col p-6 lg:p-12 items-center justify-center bg-white">
      <div class="max-w-xl w-full">
        <h2 class="text-2xl font-bold mb-2 text-center">Spill the Tea and release the negative energy.</h2>
        <p class="text-stone-500 text-center mb-8">What happens here, stays here (mostly).</p>

        <form id="teaForm" class="bg-stone-50 p-6 rounded-2xl shadow-inner border border-stone-100 relative">
          <textarea
            id="content"
            rows="6"
            placeholder="What's brewing?"
            class="w-full bg-transparent border-none focus:ring-0 text-lg resize-none placeholder-stone-300"
            required
          ></textarea>
          
          <div class="flex items-center justify-between mt-4">
            <div id="messageDisplay" class="text-sm"></div>
            <button
              type="submit"
              class="bg-stone-800 text-white px-8 py-3 rounded-full hover:bg-black transition-colors font-bold shadow-md"
            >
              Publish
            </button>
          </div>
        </form>
        
        <!-- Mobile About (Visible only on small screens) -->
        <div class="lg:hidden mt-12 p-4 bg-stone-100 rounded-lg text-sm text-stone-600 italic">
          <strong>About:</strong> The kettle is screaming... we‚Äôre brewing the scandals that others try to bury in the dark.
        </div>
      </div>
    </main>

    <!-- Right Section: Recent Pours -->
    <section class="w-full md:w-1/3 lg:w-1/4 bg-stone-50 border-l border-stone-200 flex flex-col">
      <div class="p-6 border-b border-stone-200 bg-white">
        <h3 class="text-lg font-bold flex items-center gap-2">
          <span>üî•</span> Recent Pours
        </h3>
      </div>
      <div id="feed" class="flex-1 overflow-y-auto p-6 custom-scrollbar bg-[#fdfbf7]">
        <!-- Pours injected here -->
        <div class="flex justify-center py-10">
          <div class="animate-pulse text-stone-400">Heating up the kettle...</div>
        </div>
      </div>
    </section>

  </div>

</body>
</html>
